<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Lịch Trình Tổng Quát</title>
    <!-- Favicon cho desktop -->
    <link rel="icon" type="image/x-icon" href="favicon.ico">
    <!-- Favicon cho iOS -->
    <link rel="apple-touch-icon" sizes="180x180" href="apple-touch-icon.png">
    <!-- Favicon cho Android và PWA -->
    <link rel="icon" type="image/png" sizes="192x192" href="favicon-192x192.png">
    <link rel="icon" type="image/png" sizes="512x512" href="favicon-512x512.png">
    <!-- Web app manifest cho PWA -->
    <link rel="manifest" href="manifest.json">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"/>
    <style>
        * { margin:0; padding:0; box-sizing:border-box; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; }
        :root {
            --bg1:#1a2a6c; --bg2:#b21f1f; --bg3:#fdbb2d; --card:#ffffff; --muted:#6c757d;
            --current-cell: #ffeb3b; --current-border: #ff6b6b;
        }
        body { background: linear-gradient(135deg,#e8f0ff 0%,#f8e7ee 50%,#fff7d6 100%); color:#222; }
        .container { max-width:1400px; margin:0 auto; width:100%; padding:20px; }
        header { display:flex; gap:16px; align-items:center; justify-content:space-between; margin-bottom:14px; }
        h1 { font-size:1.4rem }
        .controls { display:flex; gap:8px; align-items:center; }
        .btn { padding:8px 10px; border-radius:8px; border:0; cursor:pointer; font-weight:700; }
        .btn.ghost { background:transparent; border:2px solid rgba(0,0,0,0.08); }
        .panel { background:var(--card); border-radius:12px; padding:12px; box-shadow:0 8px 20px rgba(0,0,0,0.08); }
        .flex { display:flex; gap:8px; align-items:center; }
        .week-schedule { margin-top:12px; overflow:auto; border-radius:12px; }
        .week-table { width:100%; border-collapse:collapse; min-width:980px; }
        .week-table.single-day { min-width:300px; }
        .week-table th, .week-table td { border:1px solid rgba(0,0,0,0.06); padding:8px; vertical-align:top; }
        .week-table th { position:sticky; top:0; background:linear-gradient(90deg,var(--bg1),var(--bg2)); color:#fff; }
        .time-header { position:sticky; left:0; background:rgba(0,0,0,0.06); font-weight:700; }
        .activity-item { padding:8px; border-radius:8px; margin-bottom:6px; cursor:pointer; }
        .empty-cell { min-height:60px; padding:8px; border-radius:8px; background:rgba(0,0,0,0.03); text-align:center; cursor:pointer; }
        .current-time-cell { 
            background-color: var(--current-cell) !important; 
            position: relative;
            box-shadow: inset 0 0 0 2px var(--current-border);
            font-weight: 700;
        }
        .current-day-header { 
            background: linear-gradient(90deg, #2c3e50, #c0392b) !important;
        }
        .cat-math { background:#ffeaa7; border-left:4px solid #fdcb6e; }
        .cat-it { background:#d1ecf1; border-left:4px solid #0c5460; }
        .cat-english { background:#d4edda; border-left:4px solid #28a745; }
        .cat-sleep { background:#e3f2fd; border-left:4px solid #0d6efd; }
        .cat-break { background:#f8d7da; border-left:4px solid #dc3545; }
        .cat-class { background:#e2e3e5; border-left:4px solid #6c757d; }
        .cat-other { background:#e9d8f2; border-left:4px solid #694489; }
        .modal { display:none; position:fixed; inset:0; background:rgba(0,0,0,0.45); align-items:center; justify-content:center; z-index:1200; }
        .modal .content { background:var(--card); padding:14px; border-radius:10px; width:100%; max-width:520px; }
        .form-group { margin-bottom:8px; }
        input, textarea, select { width:100%; padding:8px; border-radius:6px; border:1px solid #ddd; }
        .toolbar { display:flex; gap:8px; flex-wrap:wrap; }
        .search { padding:8px; border-radius:8px; border:1px solid #ddd; min-width:220px; }
        .small { font-size:0.86rem; padding:6px 8px; }
        .instructions { margin-top:10px; padding:10px; border-radius:8px; background:linear-gradient(90deg,#fff7cc,#fff); }
        footer { margin-top:12px; text-align:right; opacity:0.86; }
        .section-header { background:linear-gradient(90deg,#f0f4ff,#fff); font-weight:700; padding:8px; border-bottom:1px solid rgba(0,0,0,0.06); }
        @media(max-width:760px) { 
            .controls { flex-direction:column; align-items:flex-end }
            .week-table { min-width:300px; }
        }
        #passwordProtection {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(135deg, #1a2a6c 0%, #b21f1f 50%, #fdbb2d 100%);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 9999;
            flex-direction: column;
            color: white;
        }
        .password-form {
            background: rgba(255, 255, 255, 0.1);
            padding: 30px;
            border-radius: 12px;
            backdrop-filter: blur(10px);
            box-shadow: 0 8px 32px rgba(0,0,0,0.2);
            width: 90%;
            max-width: 400px;
            text-align: center;
        }
        .password-form input {
            margin: 15px 0;
            padding: 12px;
            border: none;
            border-radius: 6px;
            background: rgba(255, 255, 255, 0.9);
        }
        .password-form button {
            background: #fff;
            color: #1a2a6c;
            padding: 12px 20px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-weight: bold;
            width: 100%;
        }
        .password-form button:hover {
            background: #f8f9fa;
        }
        .password-error {
            color: #ff6b6b;
            margin-top: 10px;
            display: none;
        }
    </style>
</head>
<body>
    <div id="passwordProtection">
        <div class="password-form">
            <h2><i class="fas fa-lock"></i> Truy cập Lịch Học</h2>
            <p>Vui lòng nhập mật khẩu để tiếp tục</p>
            <input type="password" id="passwordInput" placeholder="Nhập mật khẩu" />
            <button onclick="checkPassword()">Tiếp tục</button>
            <div class="password-error" id="passwordError">Mật khẩu không đúng. Vui lòng thử lại.</div>
        </div>
    </div>

    <div class="container" id="mainContent" style="display:none">
        <header>
            <div>
                <h1><i class="fas fa-calendar-alt"></i> Lịch Học</h1>
                <div class="small">Nhấp ô để thêm/sửa. Hỗ trợ import/export, tìm kiếm.</div>
            </div>
            <div class="controls">
                <div class="toolbar panel">
                    <input id="searchInput" class="search" placeholder="Tìm tên/ghi chú..." oninput="renderWeeklySchedule()" />
                    <select id="filterCategory" class="small" onchange="renderWeeklySchedule()">
                        <option value="">— Lọc theo loại —</option>
                        <option value="math">Toán</option>
                        <option value="it">IT</option>
                        <option value="english">Tiếng Anh</option>
                        <option value="sleep">Ngủ</option>
                        <option value="break">Giải lao</option>
                        <option value="class">Lớp</option>
                        <option value="other">Khác</option>
                    </select>
                    <select id="dayFilter" class="small" onchange="renderWeeklySchedule()">
                        <option value="">Toàn bộ tuần</option>
                        <option value="Thứ 2">Thứ 2</option>
                        <option value="Thứ 3">Thứ 3</option>
                        <option value="Thứ 4">Thứ 4</option>
                        <option value="Thứ 5">Thứ 5</option>
                        <option value="Thứ 6">Thứ 6</option>
                        <option value="Thứ 7">Thứ 7</option>
                        <option value="Chủ Nhật">Chủ Nhật</option>
                    </select>
                    <button class="btn" onclick="openImportModal()"><i class="fas fa-file-import"></i> Import</button>
                    <button class="btn" onclick="exportJSON()"><i class="fas fa-file-export"></i> Export JSON</button>
                    <button class="btn" onclick="exportCSV()"><i class="fas fa-table"></i> Export CSV</button>
                </div>
            </div>
        </header>

        <div id="mainArea">
            <div class="instructions panel">
                <b>Nhập theo mẫu tự động:</b> Dán đoạn văn từng dòng 1, dạng <code>Thứ 2,8h-9h,math,Học chương 1</code> hoặc <code>8h-9h | Thứ 2 | Toán | Học chương 1</code>. Nhấn "Phân tích và Thêm".
            </div>

            <div style="margin-top:10px; display:flex; gap:12px; align-items:flex-start;">
                <div style="flex:1">
                    <div class="panel">
                        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:8px">
                            <strong>Lịch Tuần</strong>
                        </div>
                        <div class="week-schedule panel">
                            <table class="week-table">
                                <thead>
                                    <tr id="week-table-header">
                                        <th class="time-header">Giờ</th>
                                        <th>Thứ 2</th>
                                        <th>Thứ 3</th>
                                        <th>Thứ 4</th>
                                        <th>Thứ 5</th>
                                        <th>Thứ 6</th>
                                        <th>Thứ 7</th>
                                        <th>Chủ Nhật</th>
                                    </tr>
                                </thead>
                                <tbody id="week-schedule-body"></tbody>
                            </table>
                        </div>
                    </div>
                    <div class="panel" style="margin-top:8px">
                        <strong>Tùy chỉnh thời gian</strong>
                        <div style="margin-top:8px">
                            <textarea id="timeSlotsInput" rows="6" placeholder="Nhập các khung giờ, mỗi dòng một khung (VD: 8:00-9:00)"></textarea>
                            <div style="display:flex; gap:8px; margin-top:8px;">
                                <button class="btn" onclick="saveTimeSlots()">Cập nhật khung giờ</button>
                                <button class="btn ghost" onclick="resetTimeSlots()">Đặt lại mặc định</button>
                            </div>
                        </div>
                    </div>
                    <footer>
                        <small>Lịch trình được lưu cục bộ trên thiết bị của bạn.</small><br>
                        <small>Web lưu truyền nội bộ không được phép chia sẻ!</small><br>
                        <small>Trang web chỉ được lưu hành nội bộ, tuyệt đối không chia sẻ! Nếu gặp lỗi, liên hệ admin Chuyen.</small><br>
                        <small>Chế độ chỉnh sửa cung cấp bởi Admin chuyen</small>
                    </footer>
                </div>

                <div style="width:360px">
                    <div class="panel" style="margin-bottom:8px">
                        <strong>Nhập văn bản theo mẫu</strong>
                        <textarea id="bulkInput" rows="8" placeholder="Ví dụ:\nThứ 2,8h-9h,math,Học chương 1\nThứ 3,19h-20h,english,Luyện speaking" style="margin-top:8px"></textarea>
                        <div style="display:flex; gap:8px; margin-top:8px;">
                            <button class="btn" onclick="parseAndAdd()">Phân tích và Thêm</button>
                            <button class="btn ghost" onclick="clearBulk()">Xóa</button>
                        </div>
                    </div>

                    <div class="panel" style="margin-bottom:8px">
                        <strong>Import / Export</strong>
                        <div style="display:flex; gap:8px; margin-top:8px;">
                            <input type="file" id="fileInput" style="display:none" onchange="handleFileImport(event)" />
                            <button class="btn" onclick="document.getElementById('fileInput').click()">Chọn file JSON/CSV</button>
                            <button class="btn ghost" onclick="pasteImport()">Dán JSON/CSV</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div id="activityModal" class="modal">
        <div class="content">
            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:8px">
                <strong id="modalTitle">Thêm hoạt động</strong>
                <button class="btn" onclick="closeModal()">&times;</button>
            </div>
            <div>
                <div class="form-group"><label>Tên</label><input id="activityName"/></div>
                <div class="form-group"><label>Ghi chú</label><textarea id="activityNote" rows="2"></textarea></div>
                <div class="form-group"><label>Loại</label>
                    <select id="activityCategory">
                        <option value="math">Toán</option>
                        <option value="it">IT</option>
                        <option value="english">Tiếng Anh</option>
                        <option value="sleep">Ngủ</option>
                        <option value="break">Giải lao</option>
                        <option value="class">Lớp</option>
                        <option value="other">Khác</option>
                    </select>
                </div>
                <div style="display:flex; gap:8px; justify-content:flex-end; margin-top:8px">
                    <button class="btn ghost" onclick="deleteActivity()" id="deleteBtn" style="display:none">Xóa</button>
                    <button class="btn" onclick="closeModal()">Hủy</button>
                    <button class="btn" onclick="saveActivity()">Lưu</button>
                </div>
            </div>
        </div>
    </div>

    <div id="importModal" class="modal">
        <div class="content">
            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:8px">
                <strong>Import</strong>
                <button class="btn" onclick="closeImportModal()">&times;</button>
            </div>
            <div class="form-group"><label>Dán JSON hoặc CSV</label><textarea id="importArea" rows="8"></textarea></div>
            <div style="display:flex; gap:8px; justify-content:flex-end">
                <button class="btn" onclick="applyImportText()">Áp dụng</button>
            </div>
        </div>
    </div>

    <script>
        const CORRECT_PASSWORD = "248936";
        let TIME_SLOTS = [
            "0:00-0:30", "0:30-1:00", "1:00-1:30", "1:30-2:00", "2:00-2:30", "2:30-3:00", "3:00-3:30", "3:30-4:00",
            "4:00-4:30", "4:30-5:00", "5:00-5:30", "5:30-6:00", "6:00-6:30", "6:30-7:00", "7:00-7:45", "7:45-8:00",
            "8:00-8:45", "8:45-8:50", "8:50-9:35", "9:00-9:30", "9:30-10:00", "9:35-9:40", "9:40-10:25", "10:25-10:30",
            "10:30-11:15", "11:15-11:30", "11:30-12:00", "12:00-12:30", "12:30-13:00", "13:00-13:30", "13:30-14:00",
            "14:00-14:45", "14:45-14:50", "14:50-15:35", "15:35-15:40", "15:40-16:25", "16:25-16:35", "16:35-17:00",
            "17:00-17:30", "17:30-19:00", "19:00-19:30", "19:30-20:00", "19:30-21:30", "20:00-20:30", "20:30-21:00",
            "21:00-21:30", "21:30-22:00", "22:00-22:30", "22:30-23:00", "23:00-23:30", "23:30-24:00"
        ];
        const TIME_SECTIONS = [
            { name: "Đêm", start: "0:00", end: "7:00" },
            { name: "Sáng", start: "7:00", end: "11:30" },
            { name: "Trưa", start: "11:30", end: "14:00" },
            { name: "Chiều", start: "14:00", end: "17:30" },
            { name: "Tối", start: "17:30", end: "24:00" }
        ];
        const DAYS = ["Thứ 2", "Thứ 3", "Thứ 4", "Thứ 5", "Thứ 6", "Thứ 7", "Chủ Nhật"];
        let weeklySchedule = {};
        let currentEditTime = null;
        let currentEditDay = null;
        let isEditingExisting = false;

        function checkPassword() {
            const input = document.getElementById('passwordInput').value;
            const errorElement = document.getElementById('passwordError');
            if (input === CORRECT_PASSWORD) {
                document.getElementById('passwordProtection').style.display = 'none';
                document.getElementById('mainContent').style.display = 'block';
                initializeApp();
            } else {
                errorElement.style.display = 'block';
                setTimeout(() => { errorElement.style.display = 'none'; }, 3000);
            }
        }

        document.getElementById('passwordInput').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') checkPassword();
        });

        function initializeEmptySchedule() {
            weeklySchedule = {};
            TIME_SLOTS.forEach(slot => {
                weeklySchedule[slot] = {};
                DAYS.forEach(d => weeklySchedule[slot][d] = null);
            });
        }

        function loadFromLocal() {
            const s = localStorage.getItem('weeklyScheduleV2');
            if (s) {
                try {
                    weeklySchedule = JSON.parse(s);
                    // Update TIME_SLOTS based on stored schedule
                    TIME_SLOTS = Object.keys(weeklySchedule).filter(slot => 
                        /^(\d{1,2}:\d{2})-(\d{1,2}:\d{2})$/.test(slot)
                    );
                    TIME_SLOTS.sort((a, b) => {
                        const [aStart] = a.split('-').map(t => parseTime(t));
                        const [bStart] = b.split('-').map(t => parseTime(t));
                        return aStart - bStart;
                    });
                    // Ensure all slots in TIME_SLOTS exist in weeklySchedule
                    TIME_SLOTS.forEach(slot => {
                        if (!weeklySchedule[slot]) {
                            weeklySchedule[slot] = {};
                            DAYS.forEach(d => weeklySchedule[slot][d] = null);
                        }
                    });
                    return;
                } catch (e) {
                    console.error('parse failed', e);
                }
            }
            initializeEmptySchedule();
        }

        function saveToLocal() {
            localStorage.setItem('weeklyScheduleV2', JSON.stringify(weeklySchedule));
        }

        function parseTime(timeStr) {
            const [hours, minutes] = timeStr.split(':').map(Number);
            return hours * 60 + (minutes || 0);
        }

        function saveTimeSlots() {
            const input = document.getElementById('timeSlotsInput').value.trim();
            if (!input) {
                alert('Vui lòng nhập ít nhất một khung giờ');
                return;
            }
            const newSlots = input.split('\n').map(s => s.trim()).filter(Boolean);
            const validSlots = newSlots.filter(slot => /^(\d{1,2}:\d{2})-(\d{1,2}:\d{2})$/.test(slot));
            if (validSlots.length === 0) {
                alert('Không có khung giờ hợp lệ. Vui lòng nhập theo định dạng HH:MM-HH:MM');
                return;
            }
            // Kiểm tra chồng lấn
            for (let i = 0; i < validSlots.length; i++) {
                const [start1, end1] = validSlots[i].split('-').map(t => parseTime(t));
                for (let j = i + 1; j < validSlots.length; j++) {
                    const [start2, end2] = validSlots[j].split('-').map(t => parseTime(t));
                    if (start1 < end2 && start2 < end1) {
                        alert(`Khung giờ ${validSlots[i]} chồng lấn với ${validSlots[j]}`);
                        return;
                    }
                }
            }
            const oldSchedule = weeklySchedule;
            TIME_SLOTS = validSlots.sort((a, b) => {
                const [aStart] = a.split('-').map(t => parseTime(t));
                const [bStart] = b.split('-').map(t => parseTime(t));
                return aStart - bStart;
            });
            weeklySchedule = {};
            initializeEmptySchedule();
            for (const slot of TIME_SLOTS) {
                if (oldSchedule[slot]) {
                    weeklySchedule[slot] = oldSchedule[slot];
                }
            }
            saveToLocal();
            renderWeeklySchedule();
            document.getElementById('timeSlotsInput').value = TIME_SLOTS.join('\n');
        }

        function resetTimeSlots() {
            TIME_SLOTS = [
                "0:00-0:30", "0:30-1:00", "1:00-1:30", "1:30-2:00", "2:00-2:30", "2:30-3:00", "3:00-3:30", "3:30-4:00",
                "4:00-4:30", "4:30-5:00", "5:00-5:30", "5:30-6:00", "6:00-6:30", "6:30-7:00", "7:00-7:45", "7:45-8:00",
                "8:00-8:45", "8:45-8:50", "8:50-9:35", "9:00-9:30", "9:30-10:00", "9:35-9:40", "9:40-10:25", "10:25-10:30",
                "10:30-11:15", "11:15-11:30", "11:30-12:00", "12:00-12:30", "12:30-13:00", "13:00-13:30", "13:30-14:00",
                "14:00-14:45", "14:45-14:50", "14:50-15:35", "15:35-15:40", "15:40-16:25", "16:25-16:35", "16:35-17:00",
                "17:00-17:30", "17:30-19:00", "19:00-19:30", "19:30-20:00", "19:30-21:30", "20:00-20:30", "20:30-21:00",
                "21:00-21:30", "21:30-22:00", "22:00-22:30", "22:30-23:00", "23:00-23:30", "23:30-24:00"
            ];
            const oldSchedule = weeklySchedule;
            weeklySchedule = {};
            initializeEmptySchedule();
            for (const slot of TIME_SLOTS) {
                if (oldSchedule[slot]) {
                    weeklySchedule[slot] = oldSchedule[slot];
                }
            }
            saveToLocal();
            renderWeeklySchedule();
            document.getElementById('timeSlotsInput').value = TIME_SLOTS.join('\n');
        }

        function renderWeeklySchedule() {
            const tbody = document.getElementById('week-schedule-body');
            const headerRow = document.getElementById('week-table-header');
            const table = document.querySelector('.week-table');
            tbody.innerHTML = '';
            const search = document.getElementById('searchInput').value.trim().toLowerCase();
            const filter = document.getElementById('filterCategory').value;
            const selectedDay = document.getElementById('dayFilter').value;

            // Update table header based on selected day
            headerRow.innerHTML = '<th class="time-header">Giờ</th>';
            if (selectedDay) {
                headerRow.innerHTML += `<th>${selectedDay}</th>`;
                table.classList.add('single-day');
            } else {
                DAYS.forEach(day => {
                    headerRow.innerHTML += `<th>${day}</th>`;
                });
                table.classList.remove('single-day');
            }

            TIME_SECTIONS.forEach(section => {
                const trSection = document.createElement('tr');
                const tdSection = document.createElement('td');
                tdSection.className = 'section-header';
                tdSection.colSpan = selectedDay ? 2 : 8;
                tdSection.textContent = section.name;
                trSection.appendChild(tdSection);
                tbody.appendChild(trSection);

                TIME_SLOTS.forEach(slot => {
                    const [startTime] = slot.split('-');
                    const slotTime = parseTime(startTime);
                    const sectionStart = parseTime(section.start);
                    const sectionEnd = parseTime(section.end);
                    if (slotTime >= sectionStart && slotTime < sectionEnd) {
                        const tr = document.createElement('tr');
                        const timeTd = document.createElement('td');
                        timeTd.className = 'time-header';
                        timeTd.textContent = slot;
                        tr.appendChild(timeTd);

                        const daysToRender = selectedDay ? [selectedDay] : DAYS;
                        daysToRender.forEach(day => {
                            const td = document.createElement('td');
                            const act = weeklySchedule[slot] && weeklySchedule[slot][day] ? weeklySchedule[slot][day] : null;
                            if (act && act.activity) {
                                if (filter && act.category !== filter) {
                                    td.appendChild(makeEmptyCell(slot, day));
                                    tr.appendChild(td);
                                    return;
                                }
                                const combined = (act.activity + ' ' + (act.note || '')).toLowerCase();
                                if (search && !combined.includes(search)) {
                                    td.appendChild(makeEmptyCell(slot, day));
                                    tr.appendChild(td);
                                    return;
                                }
                                const div = document.createElement('div');
                                div.className = 'activity-item cat-' + (act.category || 'other');
                                div.innerHTML = `<div style="display:flex;justify-content:space-between"><strong>${escapeHtml(act.activity)}</strong><small>${escapeHtml(act.category)}</small></div><div class="small">${escapeHtml(act.note || '')}</div>`;
                                div.onclick = () => {
                                    openEditModal(slot, day, act);
                                };
                                td.appendChild(div);
                            } else {
                                td.appendChild(makeEmptyCell(slot, day));
                            }
                            tr.appendChild(td);
                        });
                        tbody.appendChild(tr);
                    }
                });
            });
            highlightCurrentTimeAndDay();
            document.getElementById('timeSlotsInput').value = TIME_SLOTS.join('\n');
        }

        function makeEmptyCell(slot, day) {
            const div = document.createElement('div');
            div.className = 'empty-cell';
            div.innerHTML = '<i class="fas fa-plus"></i> Thêm';
            div.onclick = () => {
                openAddModal(slot, day);
            };
            return div;
        }

        function highlightCurrentTimeAndDay() {
            const now = new Date();
            const currentHour = now.getHours();
            const currentMinute = now.getMinutes();
            const currentDayIndexJS = now.getDay();
            const currentTimeInMinutes = currentHour * 60 + currentMinute;
            let currentDayName = currentDayIndexJS === 0 ? "Chủ Nhật" : `Thứ ${currentDayIndexJS + 1}`;
            const selectedDay = document.getElementById('dayFilter').value;

            document.querySelectorAll('.current-time-cell').forEach(el => {
                el.classList.remove('current-time-cell');
            });
            document.querySelectorAll('.week-table thead th').forEach(th => {
                th.classList.remove('current-day-header');
                if (!selectedDay || th.textContent.trim() === currentDayName) {
                    if (th.textContent.trim() === currentDayName) {
                        th.classList.add('current-day-header');
                    }
                }
            });

            let currentSlot = null;
            for (const slot of TIME_SLOTS) {
                const [startTime, endTime] = slot.split('-');
                const [startHour, startMinute] = startTime.split(':').map(Number);
                const [endHour, endMinute] = endTime.split(':').map(Number);
                const startTimeInMinutes = startHour * 60 + (startMinute || 0);
                const endTimeInMinutes = endHour * 60 + (endMinute || 0);
                if (currentTimeInMinutes >= startTimeInMinutes && currentTimeInMinutes < endTimeInMinutes) {
                    currentSlot = slot;
                    break;
                }
            }

            if (currentSlot && (!selectedDay || selectedDay === currentDayName)) {
                const slotIndex = TIME_SLOTS.indexOf(currentSlot);
                const rows = document.querySelectorAll('#week-schedule-body tr');
                let adjustedIndex = slotIndex;
                TIME_SECTIONS.forEach(section => {
                    const sectionStart = parseTime(section.start);
                    const sectionEnd = parseTime(section.end);
                    const slotTime = parseTime(currentSlot.split('-')[0]);
                    if (slotTime >= sectionStart && slotTime < sectionEnd) {
                        adjustedIndex += TIME_SECTIONS.slice(0, TIME_SECTIONS.indexOf(section)).length;
                    }
                });
                if (rows[adjustedIndex]) {
                    const cells = rows[adjustedIndex].querySelectorAll('td');
                    const headerCells = document.querySelectorAll('.week-table thead th');
                    let dayIndex = -1;
                    for (let i = 0; i < headerCells.length; i++) {
                        if (headerCells[i].textContent.trim() === currentDayName) {
                            dayIndex = i;
                            break;
                        }
                    }
                    if (dayIndex > 0 && cells[dayIndex]) {
                        cells[dayIndex].classList.add('current-time-cell');
                    }
                }
            }
        }

        function openAddModal(slot, day) {
            currentEditTime = slot;
            currentEditDay = day;
            isEditingExisting = false;
            document.getElementById('modalTitle').textContent = 'Thêm hoạt động';
            document.getElementById('activityName').value = '';
            document.getElementById('activityNote').value = '';
            document.getElementById('activityCategory').value = 'other';
            document.getElementById('deleteBtn').style.display = 'none';
            document.getElementById('activityModal').style.display = 'flex';
        }

        function openEditModal(slot, day, activity) {
            currentEditTime = slot;
            currentEditDay = day;
            isEditingExisting = true;
            document.getElementById('modalTitle').textContent = 'Chỉnh sửa hoạt động';
            document.getElementById('activityName').value = activity.activity || '';
            document.getElementById('activityNote').value = activity.note || '';
            document.getElementById('activityCategory').value = activity.category || 'other';
            document.getElementById('deleteBtn').style.display = 'inline-block';
            document.getElementById('activityModal').style.display = 'flex';
        }

        function closeModal() {
            document.getElementById('activityModal').style.display = 'none';
        }

        function saveActivity() {
            const name = document.getElementById('activityName').value.trim();
            if (!name) {
                alert('Nhập tên hoạt động');
                return;
            }
            const note = document.getElementById('activityNote').value.trim();
            const category = document.getElementById('activityCategory').value;
            if (!weeklySchedule[currentEditTime]) weeklySchedule[currentEditTime] = {};
            weeklySchedule[currentEditTime][currentEditDay] = { activity: name, note: note, category: category };
            saveToLocal();
            renderWeeklySchedule();
            closeModal();
        }

        function deleteActivity() {
            if (!confirm('Xóa hoạt động?')) return;
            if (weeklySchedule[currentEditTime]) weeklySchedule[currentEditTime][currentEditDay] = null;
            saveToLocal();
            renderWeeklySchedule();
            closeModal();
        }

        function exportJSON() {
            const dataStr = JSON.stringify(weeklySchedule, null, 2);
            const blob = new Blob([dataStr], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'weeklySchedule.json';
            a.click();
            URL.revokeObjectURL(url);
        }

        function exportCSV() {
            const rows = ['day,slot,activity,note,category'];
            for (const slot of TIME_SLOTS) {
                for (const day of DAYS) {
                    const a = weeklySchedule[slot] && weeklySchedule[slot][day] ? weeklySchedule[slot][day] : null;
                    if (a && a.activity) {
                        rows.push(`"${day}","${slot}","${escapeCsv(a.activity)}","${escapeCsv(a.note || '')}","${a.category}"`);
                    }
                }
            }
            const blob = new Blob([rows.join('\n')], { type: 'text/csv' });
            const url = URL.createObjectURL(blob);
            const link = document.createElement('a');
            link.href = url;
            link.download = 'weeklySchedule.csv';
            link.click();
            URL.revokeObjectURL(url);
        }

        function escapeCsv(s) {
            return (s || '').replace(/"/g, '""');
        }

        function handleFileImport(e) {
            const f = e.target.files[0];
            if (!f) return;
            const reader = new FileReader();
            reader.onload = (ev) => {
                const text = ev.target.result;
                applyImportText(text);
            };
            reader.readAsText(f);
        }

        function openImportModal() {
            document.getElementById('importArea').value = '';
            document.getElementById('importModal').style.display = 'flex';
        }

        function closeImportModal() {
            document.getElementById('importModal').style.display = 'none';
        }

        function pasteImport() {
            document.getElementById('importArea').value = prompt('Dán JSON/CSV vào đây:') || '';
            openImportModal();
        }

        function applyImportText(text) {
            if (!text) text = document.getElementById('importArea').value.trim();
            if (!text) {
                alert('Không có dữ liệu');
                return;
            }
            if (Object.keys(weeklySchedule).some(slot => Object.values(weeklySchedule[slot]).some(v => v && v.activity))) {
                if (!confirm('Import sẽ ghi đè lịch hiện tại và thay đổi khung giờ. Tiếp tục?')) return;
            }
            try {
                const parsed = JSON.parse(text);
                if (typeof parsed === 'object') {
                    // Initialize new schedule and TIME_SLOTS
                    const newSchedule = {};
                    const newSlots = [];
                    const errors = [];

                    // Validate and process JSON
                    for (const slot of Object.keys(parsed)) {
                        // Check if slot format is valid (HH:MM-HH:MM)
                        if (!/^(\d{1,2}:\d{2})-(\d{1,2}:\d{2})$/.test(slot)) {
                            errors.push(`Khung giờ không hợp lệ: ${slot}`);
                            continue;
                        }
                        // Check for overlapping slots
                        const [start, end] = slot.split('-').map(t => parseTime(t));
                        if (newSlots.some(existingSlot => {
                            const [esStart, esEnd] = existingSlot.split('-').map(t => parseTime(t));
                            return start < esEnd && esStart < end;
                        })) {
                            errors.push(`Khung giờ ${slot} chồng lấn với khung giờ khác`);
                            continue;
                        }
                        newSlots.push(slot);
                        newSchedule[slot] = {};
                        for (const day of DAYS) {
                            const act = parsed[slot][day];
                            newSchedule[slot][day] = null;
                            if (act) {
                                if ((act.activity === null || typeof act.activity === 'string') && typeof act.note === 'string' && typeof act.category === 'string') {
                                    newSchedule[slot][day] = {
                                        activity: act.activity || null,
                                        note: act.note || '',
                                        category: act.category || 'other'
                                    };
                                } else {
                                    errors.push(`Dữ liệu không hợp lệ tại ${slot}, ${day}`);
                                }
                            }
                        }
                    }

                    if (newSlots.length === 0) {
                        alert('Không tìm thấy khung giờ hợp lệ trong JSON');
                        return;
                    }

                    // Update TIME_SLOTS with slots from JSON
                    TIME_SLOTS = newSlots.sort((a, b) => {
                        const [aStart] = a.split('-').map(t => parseTime(t));
                        const [bStart] = b.split('-').map(t => parseTime(t));
                        return aStart - bStart;
                    });

                    // Initialize schedule with new TIME_SLOTS
                    weeklySchedule = newSchedule;

                    saveToLocal();
                    renderWeeklySchedule();
                    closeImportModal();
                    if (errors.length > 0) {
                        alert(`Import JSON thành công, nhưng có lỗi:\n${errors.join('\n')}`);
                    } else {
                        alert('Import JSON thành công');
                    }
                    return;
                }
            } catch (e) {
                console.error('JSON parse failed', e);
                alert(`Lỗi phân tích JSON: ${e.message}`);
            }
            // Handle CSV
            const lines = text.split(/\r?\n/).map(s => s.trim()).filter(Boolean);
            initializeEmptySchedule();
            const newCsvSlots = new Set();
            for (const line of lines) {
                const parts = line.split(/,|\|/).map(p => p.trim().replace(/^"|"$/g, ''));
                if (parts.length >= 4) {
                    const day = parts[0];
                    const slot = parts[1];
                    const category = parts[4] || 'other';
                    const activity = parts[2] || '';
                    const note = parts[3] || '';
                    if (/^(\d{1,2}:\d{2})-(\d{1,2}:\d{2})$/.test(slot) && DAYS.includes(day)) {
                        newCsvSlots.add(slot);
                        if (!weeklySchedule[slot]) weeklySchedule[slot] = {};
                        weeklySchedule[slot][day] = { activity: activity, note: note, category: category };
                    }
                }
            }
            // Update TIME_SLOTS with slots from CSV
            if (newCsvSlots.size > 0) {
                TIME_SLOTS = Array.from(newCsvSlots).sort((a, b) => {
                    const [aStart] = a.split('-').map(t => parseTime(t));
                    const [bStart] = b.split('-').map(t => parseTime(t));
                    return aStart - bStart;
                });
                const oldSchedule = weeklySchedule;
                weeklySchedule = {};
                initializeEmptySchedule();
                for (const slot of TIME_SLOTS) {
                    if (oldSchedule[slot]) {
                        weeklySchedule[slot] = oldSchedule[slot];
                    }
                }
            }
            saveToLocal();
            renderWeeklySchedule();
            closeImportModal();
            alert('Import CSV cơ bản hoàn tất');
        }

        function parseAndAdd() {
            const txt = document.getElementById('bulkInput').value.trim();
            if (!txt) {
                alert('Chưa có input');
                return;
            }
            const lines = txt.split(/\r?\n/).map(s => s.trim()).filter(Boolean);
            const newSlots = new Set(TIME_SLOTS);
            for (const line of lines) {
                let parts = null;
                if (line.includes('|')) parts = line.split('|').map(p => p.trim());
                else parts = line.split(',').map(p => p.trim());
                if (parts.length >= 4) {
                    let day = '', slot = '', category = 'other', desc = '';
                    if (DAYS.includes(parts[0])) {
                        day = parts[0];
                        slot = parts[1];
                        category = parts[2];
                        desc = parts.slice(3).join(',');
                    } else if (DAYS.includes(parts[1])) {
                        slot = parts[0];
                        day = parts[1];
                        category = parts[2];
                        desc = parts.slice(3).join(',');
                    } else {
                        for (const p of parts) {
                            for (const d of DAYS) {
                                if (p.toLowerCase().includes(d.toLowerCase().replace(' ', '').replace('ú', 'u')) || p.toLowerCase().includes(d.toLowerCase().split(' ')[1])) {
                                    day = d;
                                }
                            }
                        }
                        slot = parts[0];
                        category = parts[2] || 'other';
                        desc = parts.slice(3).join(',');
                    }
                    if (!DAYS.includes(day)) {
                        console.warn('Bỏ dòng (không nhận ngày):', line);
                        continue;
                    }
                    if (!/^(\d{1,2}:\d{2})-(\d{1,2}:\d{2})$/.test(slot)) {
                        const s = slot.replace(/\s+/g, '').replace(':00', '').replace(':', '').toLowerCase();
                        if (TIME_SLOTS.includes(s)) slot = s;
                        else {
                            console.warn('Slot không hợp lệ:', slot);
                            continue;
                        }
                    }
                    newSlots.add(slot);
                    if (!weeklySchedule[slot]) weeklySchedule[slot] = {};
                    weeklySchedule[slot][day] = { activity: category || 'Hoạt động', note: desc || '', category: category || 'other' };
                }
            }
            // Update TIME_SLOTS with new slots
            TIME_SLOTS = Array.from(newSlots).sort((a, b) => {
                const [aStart] = a.split('-').map(t => parseTime(t));
                const [bStart] = b.split('-').map(t => parseTime(t));
                return aStart - bStart;
            });
            const oldSchedule = weeklySchedule;
            weeklySchedule = {};
            initializeEmptySchedule();
            for (const slot of TIME_SLOTS) {
                if (oldSchedule[slot]) {
                    weeklySchedule[slot] = oldSchedule[slot];
                }
            }
            saveToLocal();
            renderWeeklySchedule();
            alert('Đã phân tích và thêm (bỏ các dòng không hợp lệ)');
        }

        function clearBulk() {
            document.getElementById('bulkInput').value = '';
        }

        function escapeHtml(s) {
            return (s || '').replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;');
        }

        function initializeApp() {
            loadFromLocal();
            renderWeeklySchedule();
            setInterval(highlightCurrentTimeAndDay, 60 * 1000);
        }
    </script>
</body>
</html>